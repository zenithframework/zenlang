# Zen Package Manager (zenpkg)

## 1. Overview

`zenpkg` is the official package manager and build system for the Zenith programming language. It manages dependencies, builds projects, publishes packages, and provides scaffolding tools for creating new applications. All Zenith projects are defined by a `Zen.toml` manifest file.

**Key Features:**
- Dependency management with version resolution
- Lock file for reproducible builds
- Semantic versioning support
- Package registry integration
- Integrated build system
- Scaffolding and code generation
- Testing framework integration

## 2. Core Principles

- **Simplicity**: Intuitive commands and configuration for both consumers and publishers
- **Reliability**: Reproducible builds through lock files and deterministic dependency resolution
- **Performance**: Efficient caching, parallel builds, and minimal compilation overhead
- **Security**: Package verification, dependency scanning, and secure registry communication
- **Developer Experience**: Minimal configuration, clear error messages, and helpful guidance

## 3. Installation

### Automatic Installation
Download and run the installer for your platform:

**macOS/Linux:**
```bash
curl -fsSL https://install.zenith-lang.org/zenpkg | sh
```

**Windows:**
```powershell
irm https://install.zenith-lang.org/zenpkg.ps1 | iex
```

**Manual Installation:**
1. Download the latest release from [GitHub Releases](https://github.com/zenith-lang/zenith/releases)
2. Extract to `/usr/local/bin` (Unix) or `Program Files` (Windows)
3. Run `zenpkg --version` to verify installation

### From Source
```bash
git clone https://github.com/zenith-lang/zenith.git
cd zenith
make install  # Unix
nmake install # Windows
```

## 4. Project Structure

A typical Zenith project:

```
my_zen_project/
├── Zen.toml              # Project manifest
├── zen.lock              # Dependency lock file (auto-generated)
├── src/                  # Source code
│   └── main.zen
├── tests/                # Test files
│   └── test_main.zen
├── target/               # Build output (auto-generated)
│   ├── debug/
│   └── release/
├── bin/                  # Binary entry points
│   └── main.zen
├── lib/                  # Library code
│   └── lib.zen
└── .gitignore
```

## 5. Zen.toml Manifest File

The `Zen.toml` file defines project metadata, dependencies, and build configuration in TOML format.

### Minimal Example
```toml
[package]
name = "my_app"
version = "0.1.0"
authors = ["Your Name <you@example.com>"]
edition = "2025"
description = "A simple Zenith application"
license = "MIT"
repository = "https://github.com/you/my_app"

[dependencies]
# No external dependencies yet
```

### Complete Example
```toml
[package]
name = "zenith_web_app"
version = "1.0.0"
authors = [
    "Alice Chen <alice@example.com>",
    "Bob Smith <bob@example.com>"
]
edition = "2025"
description = "A full-stack web application built with Zenith"
license = "MIT"
repository = "https://github.com/example/zenith_web_app"
homepage = "https://zenith-app.example.com"
keywords = ["web", "framework", "zenith"]
categories = ["web-frameworks", "database"]

[dependencies]
# Version specifications
zenith_framework = "1.0"              # Exact version
zenith_orm = "^2.1"                   # Compatible with 2.1.x
zenith_http = "~2.5"                  # Compatible with 2.5.x
zenith_cache = "1.2.*"                # Compatible with 1.2.x
serde = { version = "1.0", optional = true }

# Git dependencies
my_private_lib = { git = "https://github.com/example/my_private_lib.git", branch = "main" }

# Path dependencies (for local development)
local_utils = { path = "../local_utils" }

# Optional dependencies (for feature flags)
async_runtime = { version = "0.2", optional = true }

[dev-dependencies]
testing_framework = "1.0"
mockito = "0.12"

[build-dependencies]
protobuf_compiler = "0.1"

[[bin]]
name = "app"
path = "bin/main.zen"

[features]
# Feature flags
default = ["database", "web"]
database = []
web = []
async = ["async_runtime"]
full = ["database", "web", "async"]

[profile.dev]
opt-level = 0
debug = true
debug-assertions = true
lto = false

[profile.release]
opt-level = 3
debug = false
debug-assertions = false
lto = true
```

## 6. zen.lock Lock File

The lock file (automatically generated) records exact versions of all dependencies for reproducible builds:

```toml
# This file is automatically generated by zenpkg.
# Do not edit manually. Commit this file to version control.

[[package]]
name = "zenith_framework"
version = "1.0.5"
source = "registry+https://pkg.zenith-lang.org/"
dependencies = [
    "zenith_core 1.0.3",
    "zenith_macros 0.5.1",
]

[[package]]
name = "zenith_core"
version = "1.0.3"
source = "registry+https://pkg.zenith-lang.org/"

[[package]]
name = "my_private_lib"
version = "0.1.0"
source = "git+https://github.com/example/my_private_lib.git?branch=main#abcd1234"
```

## 7. Command-Line Interface

### Project Initialization

```bash
# Create a new project
zenpkg new my_app                 # Binary application
zenpkg new --lib my_lib           # Library
zenpkg new --template web my_site # Web application
zenpkg new --template api my_api  # REST API

# Initialize in existing directory
cd existing_project
zenpkg init
```

### Dependency Management

```bash
# Install all dependencies
zenpkg install

# Add a specific dependency
zenpkg add package_name
zenpkg add package_name@1.2.3              # Specific version
zenpkg add package_name@^1.0               # Semver compatible
zenpkg add github:user/repo                # From GitHub
zenpkg add git+https://github.com/...      # From Git URL

# Add development dependency
zenpkg add --dev testing_framework

# Remove dependency
zenpkg remove package_name
zenpkg remove --dev testing_framework

# Update dependencies
zenpkg update                     # Update to latest compatible
zenpkg update package_name        # Update specific package
zenpkg upgrade                    # Major version updates (use with caution)

# List dependencies
zenpkg list
zenpkg list --depth 2             # Show transitive dependencies

# Check for dependency conflicts
zenpkg check
```

### Building and Running

```bash
# Build project (debug mode)
zenpkg build
zenpkg build --verbose            # Show compilation details

# Build optimized release
zenpkg build --release
zenpkg build -r                   # Short form

# Clean build artifacts
zenpkg clean

# Run project
zenpkg run
zenpkg run --release              # Run release build
zenpkg run -- arg1 arg2           # Pass arguments

# Run specific binary
zenpkg run --bin app_name

# Run with environment variables
zenpkg run --env DEV=true

# Watch for changes and rebuild
zenpkg watch
zenpkg watch --test               # Watch and run tests
```

### Testing

```bash
# Run all tests
zenpkg test
zenpkg test --verbose             # Show detailed output
zenpkg test --nocapture           # Show println! output

# Run specific test file
zenpkg test tests/feature/user.zen

# Run tests matching pattern
zenpkg test user                  # Runs tests with "user" in name

# Run with coverage
zenpkg test --coverage
zenpkg test --coverage --html     # Generate HTML report

# Run benchmarks
zenpkg bench
```

### Code Quality

```bash
# Format code
zenpkg fmt
zenpkg fmt --check                # Check without modifying

# Lint code
zenpkg lint
zenpkg lint --strict              # Enable strict mode

# Generate documentation
zenpkg doc                        # Generate docs
zenpkg doc --open                 # Open in browser

# Type checking
zenpkg check
```

### Publishing

```bash
# Prepare for publishing
zenpkg publish --dry-run          # Test without uploading

# Publish to Zenith registry
zenpkg publish
zenpkg publish --token YOUR_TOKEN # With authentication token

# Publish to custom registry
zenpkg publish --registry https://private.example.com

# View package info
zenpkg info package_name
```

### Scaffolding (Framework Projects)

```bash
# For web framework projects
zenpkg make:controller UserController
zenpkg make:model User
zenpkg make:migration create_users_table
zenpkg make:middleware AuthMiddleware
zenpkg make:service EmailService
zenpkg make:request StoreUserRequest
zenpkg make:resource User               # Full CRUD resource
zenpkg make:crud User                   # Alternative syntax

# Generate test
zenpkg make:test UserTest
```

### Miscellaneous

```bash
# Display version
zenpkg --version
zenpkg -V

# Show help
zenpkg --help
zenpkg help <command>

# Display tool versions
zenpkg --show-versions

# Verify installation
zenpkg verify
```

## 8. Version Specifications

Zenith uses semantic versioning. Dependency versions can be specified as:

```toml
[dependencies]
# Exact version
exact = "1.2.3"

# Caret: compatible with specified version
compatible = "^1.2.3"  # >= 1.2.3, < 2.0.0
compatible_major = "^0.2.3"  # >= 0.2.3, < 0.3.0

# Tilde: approximately equivalent
approximate = "~1.2.3"  # >= 1.2.3, < 1.3.0

# Wildcard
wildcard = "1.2.*"  # >= 1.2.0, < 1.3.0

# Comparison operators
greater = ">1.0"
greater_eq = ">=1.0"
less = "<2.0"
less_eq = "<=2.0"
not_eq = "!=1.5"

# Range
range = ">=1.0, <2.0"

# Or (alternative versions)
or_versions = "1.0 || 2.0 || 3.0"
```

## 9. Configuration

### Global Configuration File

Location: `~/.zenpkg/config.toml` (Unix) or `%APPDATA%\zenpkg\config.toml` (Windows)

```toml
[registry]
default = "https://pkg.zenith-lang.org"
token = "your_authentication_token"

[cache]
dir = "~/.zenpkg/cache"
ttl = 3600  # seconds

[build]
jobs = 4    # Parallel build jobs
```

### Environment Variables

```bash
# Override registry URL
ZENPKG_REGISTRY=https://private.example.com

# Authentication token
ZENPKG_TOKEN=your_token_here

# Cache directory
ZENPKG_CACHE_DIR=/tmp/zenpkg_cache

# Build parallelism
ZENPKG_BUILD_JOBS=8

# Verbose output
ZENPKG_VERBOSE=1
```

## 10. Zen Package Registry

The Zenith package registry is hosted at `https://pkg.zenith-lang.org/` and provides:

- Central repository of published packages
- Semantic version resolution
- Dependency tracking
- Package documentation
- Security scanning
- Usage statistics

### Publishing to Registry

```bash
# Login to registry
zenpkg login
zenpkg login --registry https://private.example.com

# Publish your package
zenpkg publish

# View your published packages
zenpkg search my_package
```

### Private Registries

For private packages, configure alternative registries:

```toml
[registries]
private = { url = "https://private.example.com", token = "secret_token" }

[dependencies]
my_private_lib = { version = "1.0", registry = "private" }
```

## 11. Dependency Resolution

`zenpkg` uses sophisticated algorithms to resolve dependencies:

1. **Version Selection**: Finds the highest compatible version within constraints
2. **Conflict Resolution**: Detects and reports version conflicts
3. **Transitive Dependencies**: Automatically includes required sub-dependencies
4. **Lock File**: Ensures reproducible builds across environments

### Common Issues and Solutions

**Conflict: No version satisfies all constraints**
```
Error: Could not resolve dependency constraints:
  foo = "^1.0" (required by myapp)
  foo = "^2.0" (required by bar)
```
Solution: Update your version constraints or find a common dependency version.

**Circular dependencies**
```
Error: Circular dependency detected: a -> b -> c -> a
```
Solution: Restructure code to eliminate circular imports.

## 12. Development Workflow

### Typical Workflow

```bash
# 1. Create new project
zenpkg new my_app
cd my_app

# 2. Add dependencies
zenpkg add zenith_framework
zenpkg add --dev testing_framework

# 3. Write code
echo 'print("Hello, Zenith!");' > src/main.zen

# 4. Test during development
zenpkg watch --test

# 5. Run the app
zenpkg run

# 6. Format and lint before committing
zenpkg fmt
zenpkg lint

# 7. Build release version
zenpkg build --release

# 8. Publish
zenpkg publish
```

### Working with Local Dependencies

For monorepos or local development:

```toml
[dependencies]
my_local_lib = { path = "../my_local_lib" }
```

After making changes to local dependencies, just rebuild:
```bash
zenpkg build  # Automatically detects changes
```

## 13. Performance

### Build Performance Tips

1. **Use incremental compilation**: `zenpkg` automatically caches compilation artifacts
2. **Parallel builds**: Configure `build.jobs` in config for optimal parallelism
3. **Release mode**: Use `--release` for production builds (10x faster execution)
4. **Check mode**: Use `zenpkg check` instead of full builds during development

### Common Benchmarks

- Simple app build: 0.5-1.0s (debug), 2-5s (release)
- Large project: 5-20s (debug), 20-60s (release)
- Incremental rebuild: 0.1-0.5s (most changes)

## 14. Security

### Dependency Scanning

```bash
# Check for known vulnerabilities
zenpkg audit
zenpkg audit --fix  # Attempt automatic fixes
```

### Package Verification

All packages in the official registry are:
- Scanned for malware
- Checked for license compliance
- Verified for authenticity
- Monitored for security updates

### Best Practices

1. Keep dependencies up-to-date: `zenpkg update`
2. Regularly audit: `zenpkg audit`
3. Review `Zen.lock` before committing
4. Use dependency version constraints to manage updates
5. Monitor security advisories

## 15. Troubleshooting

### Common Issues

**"Package not found"**
```
Solution: Ensure package name is correct and exists in registry
zenpkg search package_name
```

**"Version conflict"**
```
Solution: Update version constraints in Zen.toml
zenpkg update package_name
```

**"Build fails unexpectedly"**
```
Solution: Clean and rebuild
zenpkg clean
zenpkg build --verbose
```

**"Slow build times"**
```
Solution: Increase build jobs
zenpkg build --jobs 8
```

## 16. FAQ

**Q: How often should I update dependencies?**
A: At least monthly, or when security updates are available. Use `zenpkg audit` to check.

**Q: Can I use packages from GitHub without the registry?**
A: Yes: `zenpkg add git+https://github.com/user/repo.git`

**Q: How do I create a private package?**
A: Set up a private registry and configure it in `Zen.toml`.

**Q: Is there a way to offline install dependencies?**
A: Use `zenpkg vendor` to create a vendor directory (PLANNED for v1.5).

## 17. Advanced Topics

### Creating Custom Builds

```bash
# Custom build script in Zen.toml
[build]
script = "build.zen"  # Custom build logic
```

### Publishing with CI/CD

```yaml
# .github/workflows/publish.yml
name: Publish
on:
  release:
    types: [created]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
      - run: zenpkg publish --token ${{ secrets.ZENPKG_TOKEN }}
```

## 18. Roadmap

- **v1.0**: Core functionality (stable)
- **v1.5**: Workspace support, vendoring, git dependencies
- **v2.0**: WASM build targets, cross-compilation
- **v3.0**: Package signing, trust chain verification

---

See also: [Zenith Language](./ZenithLanguage.md) | [Web Framework](./ZenWebFramework.md) | [Compiler](./ZenithCompiler.md)
